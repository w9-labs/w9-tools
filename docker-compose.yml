version: '3.8'

services:
  # W9 Tools Backend
  w9-tools-backend:
    image: ghcr.io/${GITHUB_USER:-your-username}/w9-tools-backend:latest
    container_name: w9-tools-backend
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    ports:
      - "${W9_TOOLS_PORT:-10105}:8080"
    environment:
      - HOST=0.0.0.0
      - PORT=8080
      - BASE_URL=${W9_TOOLS_BASE_URL:-https://w9.se}
      - DATABASE_PATH=/app/data/w9.db
      - UPLOADS_DIR=/app/uploads
      - W9_MAIL_API_URL=${W9_MAIL_API_URL:-https://w9.nu}
      - W9_MAIL_API_TOKEN=${W9_MAIL_API_TOKEN:-}
      - JWT_SECRET=${JWT_SECRET:-}
      - EMAIL_FROM_ADDRESS=${W9_TOOLS_EMAIL_FROM:-W9 Tools <no-reply@w9.se>}
      - PASSWORD_RESET_BASE_URL=${W9_TOOLS_PASSWORD_RESET_URL:-${W9_TOOLS_BASE_URL:-https://w9.se}/reset-password}
      - VERIFICATION_BASE_URL=${W9_TOOLS_VERIFICATION_URL:-${W9_TOOLS_BASE_URL:-https://w9.se}/verify}
      - TURNSTILE_SECRET_KEY=${W9_TOOLS_TURNSTILE_SECRET:-}
      - QR_LOGO_PATH=${QR_LOGO_PATH:-}
      - DEFAULT_ADMIN_EMAIL=${W9_TOOLS_ADMIN_EMAIL:-}
      - DEFAULT_ADMIN_PASSWORD=${W9_TOOLS_ADMIN_PASSWORD:-}
    volumes:
      - w9-tools-data:/app/data
      - w9-tools-uploads:/app/uploads
    networks:
      - w9-tools-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # W9 Tools Frontend
  w9-tools-frontend:
    image: ghcr.io/${GITHUB_USER:-your-username}/w9-tools-frontend:latest
    container_name: w9-tools-frontend
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    ports:
      - "${W9_TOOLS_FRONTEND_PORT:-8081}:80"
    networks:
      - w9-tools-network
    depends_on:
      - w9-tools-backend

  # Watchtower - Auto-update containers
  watchtower:
    image: containrrr/watchtower:latest
    container_name: w9-tools-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_INCLUDE_STOPPED=true
      - WATCHTOWER_LABEL_ENABLE=true
    command: --interval 300 --scope w9-tools-backend w9-tools-frontend
    networks:
      - w9-tools-network

volumes:
  w9-tools-data:
    driver: local
  w9-tools-uploads:
    driver: local

networks:
  w9-tools-network:
    driver: bridge

